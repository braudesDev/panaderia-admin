<h1>Ruta del Día – Primera Vuelta</h1>

<app-scanner-qr (qrEscaneado)="procesarQr($event)"></app-scanner-qr>

<!-- Versión combinada optimizada -->
<div *ngFor="let tienda of tiendas; trackBy: trackByClienteId" class="card">
  <!-- Busca el registro por clienteId en lugar de usar el índice -->
  <mat-card [class.activo]="getRegistro(tienda.clienteId)?.clienteId === clienteActual?.clienteId">
    <mat-card-header>
      <mat-card-title>{{ tienda.tienda }}</mat-card-title>
      <mat-card-subtitle>{{ tienda.direccion }} - {{ tienda.hora }}</mat-card-subtitle>
    </mat-card-header>

    <!-- Muestra contenido solo si es el cliente actual -->
    <mat-card-content *ngIf="getRegistro(tienda.clienteId)?.clienteId === clienteActual?.clienteId">
      <ng-container *ngIf="getRegistro(tienda.clienteId) as registro">

        <!-- Tus formularios originales (seguros con getRegistro) -->
        <mat-form-field appearance="outline">
          <mat-label>Entrega Inicial</mat-label>
          <input matInput type="number" [(ngModel)]="registro.entregaInicial" min="0"
                (ngModelChange)="actualizarCobroTotal(registro)" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Entrega Extra</mat-label>
          <input matInput type="number" [(ngModel)]="registro.entregaExtra" min="0"
                (ngModelChange)="actualizarCobroTotal(registro)" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Tiras Sobrantes</mat-label>
          <input matInput type="number" [(ngModel)]="registro.tirasSobrantes" min="0"
                (ngModelChange)="actualizarCobroTotal(registro)" />
        </mat-form-field>

        <p><strong>Tiras Vendidas:</strong> {{ registro.tirasVendidas }}</p>
        <p><strong>Cobro Total:</strong> ${{ registro.cobroTotal }}</p>

      </ng-container>
    </mat-card-content>
  </mat-card>
</div>

<!-- Botón con spinner de carga -->
<button mat-raised-button color="primary" (click)="registrarEntregas()" [disabled]="isLoading">
  <span *ngIf="!isLoading">Guardar entregas</span>
  <mat-spinner *ngIf="isLoading" diameter="20" strokeWidth="3"></mat-spinner>
</button>
